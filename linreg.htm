
<!-- saved from url=(0066)https://mimno.github.io/info3300-spr2017/Prompts/032017/index.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>INFO 3300 - Data-driven Web Applications</title>
<link href="./linreg_files/css" rel="stylesheet">
<link rel="stylesheet" href="./linreg_files/default.min.css">
<script src="./linreg_files/d3.v4.min.js"></script><style></style>
<script src="./linreg_files/highlight.min.js"></script>
<style>
body { font-family: 'Slabo 27px', Calibri, sans-serif; }
svg { border: solid #ccc 1px; }
input.slider { width: 300px; }
</style>
<style id="style-1-cropbar-clipper">/* Copyright 2014 Evernote Corporation. All rights reserved. */
.en-markup-crop-options {
    top: 18px !important;
    left: 50% !important;
    margin-left: -100px !important;
    width: 200px !important;
    border: 2px rgba(255,255,255,.38) solid !important;
    border-radius: 4px !important;
}

.en-markup-crop-options div div:first-of-type {
    margin-left: 0px !important;
}
</style></head>
<body>
<h3>Prompt for Monday, March 20</h3>

<div>
<ul>
	<li>Reflections on <a href="https://medium.com/@dominikus/the-end-of-interactive-visualizations-52c585dcafcb#.a2futdtt4">the death of interactive graphics</a>. What do you think?</li>
	<li>Fun: <a href="http://codepen.io/nerdmanship/full/xgmBKg/">Miyazaki tribute in SVG/JS</a>. Can you figure out how it works?</li>
	<li>For today: What factors influence <a href="https://en.wikipedia.org/wiki/Programme_for_International_Student_Assessment">International Math test scores</a>?</li>
</ul>
</div>

<!-- Data sources, all via Wikipedia

2015 PISA Math: https://en.wikipedia.org/wiki/Programme_for_International_Student_Assessment (OECD)
GDP per capita: https://en.wikipedia.org/wiki/List_of_countries_by_GDP_(nominal)_per_capita (IMF)
Income Inequality: https://en.wikipedia.org/wiki/List_of_countries_by_income_equality (UN, WB, CIA)
Human Development Index: https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index (UN)
Education spending as % of GDP: https://en.wikipedia.org/wiki/List_of_countries_by_spending_on_education_(%25_of_GDP) (World bank)

-->

<div>
	<ul>
		<li>How does regression work with multiple inputs?</li>
		<li>What can go wrong when we integrate data sources?</li>
		<li>How do we handle interaction?</li>
	</ul>
</div>

<div id="plot"></div>

<script id="notes">

var height = 400;
var width = 400;
var padding = 40;

var svg = d3.select("#plot").append("svg")
.attr("height", height + 2 * padding).attr("width", width + 2 * padding)
.append("g").attr("transform", "translate(" + padding + "," + padding + ")");

// What are the largest and smallest data values?
var extent = [200, 600];

var xScale = d3.scaleLinear().domain(extent).range([0, width]);
var yScale = d3.scaleLinear().domain(extent).range([height, 0]);

var xAxis = d3.axisBottom(xScale);
svg.append("g").call(xAxis).attr("transform", "translate(0, "+ (height) + ")");
svg.append("text").attr("x", width / 2).attr("y", height + 35).text("Predicted PISA");

var yAxis = d3.axisLeft(yScale);
svg.append("g").call(yAxis);
svg.append("text").attr("transform", "rotate(270)")
.attr("x", -width / 2).attr("y", -25).text("Actual PISA");

var identityLine = svg.append("line")
.attr("class", "estimated")
.attr("x1", xScale(extent[0]))
.attr("y1", yScale(extent[0]))
.attr("x2", xScale(extent[1]))
.attr("y2", yScale(extent[1]))
.style("stroke", "#e41a1c");

var label = svg.append("text");

var normalGenerator = d3.randomNormal();

var points = [];

var predictedVariable = "PISA";
var inputVariables = ["Income", "Inequality", "EduSpend", "HDI"];
var variableMean = {};
var variableStdDev = {};

var randomModel = function () {
	var model = { intercept: 0.0 };
	
	inputVariables.forEach(function (variable) {
		model[variable] = normalGenerator() * 0.01;
	});
	
	return model;
}

var model = randomModel();

// Get the "residual", or difference between observed value and predicted value
function calculateErrors(points, model) {
	points.forEach(function (point) {
		// Y = ... + b
		point["prediction"] = model.intercept;
		inputVariables.forEach(function (variable) {
			// Y = mx...
			point["prediction"] += model[variable] * point[variable];
		});
		// Real Y - our current guess
		point.error = point[predictedVariable] - point["prediction"];
	});
}

// Display the squared loss criterion
function squaredError() {
	return d3.sum(points, function (point) {
		return point.error * point.error;
	});
}

var lossFunction = squaredError;
var rounder = d3.format(".5g");

var modelText = svg.append("text")
.attr("id", "status")
.attr("x", 10).attr("y", 30)
.text("Loss: " +
rounder(lossFunction()));

// Save data values outside the callback function. (Useful for debugging.)
var pisa, gdp, education, gini, hdi;

d3.queue()
.defer(d3.tsv, "pisa.txt")
.defer(d3.tsv, "gdp.txt")
.defer(d3.tsv, "education.txt")
.defer(d3.tsv, "gini.txt")
.defer(d3.tsv, "hdi.txt")
.await(function (error, _pisa, _gdp, _education, _gini, _hdi) {
	points = [];
	gdp = d3.nest().key(function (d) { return d.Country; }).map(_gdp);
	education = d3.nest().key(function (d) { return d.Country; }).map(_education);
	gini = d3.nest().key(function (d) { return d.Country; }).map(_gini);
	hdi = d3.nest().key(function (d) { return d.Country; }).map(_hdi);
	
	_pisa.forEach(function (country) {
		var countryName = country.Country;
		try {
			country["PISA"] = country["PISA"];
			country["Income"] = gdp.get(countryName)[0]["GDP"]);
			country["EduSpend"] = education.get(countryName)[0]["Education"];
			country["Inequality"] = gini.get(countryName)[0]["WBGini"];
			country["HDI"] = hdi.get(countryName)[0]["HDI"];
			
			points.push(country);
		} catch (error) { 
			console.log("problem with " + countryName);
		}
	});
	
	model.intercept = d3.mean(points, function (d) { return d[predictedVariable]; });
	
	var slidersDiv = d3.select("#plot").append("div")
	.style("float", "right");
	
	slidersDiv
	.append("div").text("Intercept")
	.append("div")
	.append("input").attr("type", "range").attr("class", "slider")
	.attr("min", model.intercept - 200)
	.attr("max", model.intercept + 200).attr("step", 2)
	.attr("value", model.intercept)
	.on("input", function () {
		model.intercept = Number(this.value);
		display();
	});
	
	inputVariables.forEach(function (variable) {
		variableMean[variable] = d3.mean(points, function (d) { return d[variable]; });
		variableStdDev[variable] = d3.deviation(points, function (d) { return d[variable]; });
		
		var varMin = -30 / variableStdDev[variable];
		var varMax = 30 / variableStdDev[variable];
		var step = (varMax - varMin) / 100;
		slidersDiv
		.append("div").text(variable)
		.append("div")
		.append("input").attr("type", "range").attr("class", "slider")
		.attr("min", varMin).attr("max", varMax).attr("step", step).attr("value", model[variable])
		.on("input", function () {
			model[variable] = Number(this.value);
			display();
		});
	});
	
	display();
});

function display() {
	calculateErrors(points, model);

	var circles = svg.selectAll("circle").data(points);
	
	circles.enter()
	.append("circle")
	.merge(circles)
	.attr("r", 5)
	.on("click", function (d) {
		label.attr("x", xScale(d["prediction"]))
		.attr("y", yScale(d[predictedVariable]))
		.text(d.Country);
	})
	.style("opacity", 0.4)
	.attr("cx", function (d) { return xScale(d["prediction"]); })
	.attr("cy", function (d) { return yScale(d[predictedVariable]); });

	modelText
	.text("Loss: " + rounder(lossFunction()));	
}

</script>

<!-- This block will be automatically filled with syntax-highlighted code from the script below -->
<pre><code id="display" class="hljs http">

<span class="javascript"><span class="hljs-keyword">var</span> height = <span class="hljs-number">400</span>;
<span class="hljs-keyword">var</span> width = <span class="hljs-number">400</span>;
<span class="hljs-keyword">var</span> padding = <span class="hljs-number">40</span>;

<span class="hljs-keyword">var</span> svg = d3.select(<span class="hljs-string">"#plot"</span>).append(<span class="hljs-string">"svg"</span>)
.attr(<span class="hljs-string">"height"</span>, height + <span class="hljs-number">2</span> * padding).attr(<span class="hljs-string">"width"</span>, width + <span class="hljs-number">2</span> * padding)
.append(<span class="hljs-string">"g"</span>).attr(<span class="hljs-string">"transform"</span>, <span class="hljs-string">"translate("</span> + padding + <span class="hljs-string">","</span> + padding + <span class="hljs-string">")"</span>);

<span class="hljs-comment">// What are the largest and smallest data values?</span>
<span class="hljs-keyword">var</span> extent = [<span class="hljs-number">200</span>, <span class="hljs-number">600</span>];

<span class="hljs-keyword">var</span> xScale = d3.scaleLinear().domain(extent).range([<span class="hljs-number">0</span>, width]);
<span class="hljs-keyword">var</span> yScale = d3.scaleLinear().domain(extent).range([height, <span class="hljs-number">0</span>]);

<span class="hljs-keyword">var</span> xAxis = d3.axisBottom(xScale);
svg.append(<span class="hljs-string">"g"</span>).call(xAxis).attr(<span class="hljs-string">"transform"</span>, <span class="hljs-string">"translate(0, "</span>+ (height) + <span class="hljs-string">")"</span>);
svg.append(<span class="hljs-string">"text"</span>).attr(<span class="hljs-string">"x"</span>, width / <span class="hljs-number">2</span>).attr(<span class="hljs-string">"y"</span>, height + <span class="hljs-number">35</span>).text(<span class="hljs-string">"Predicted PISA"</span>);

<span class="hljs-keyword">var</span> yAxis = d3.axisLeft(yScale);
svg.append(<span class="hljs-string">"g"</span>).call(yAxis);
svg.append(<span class="hljs-string">"text"</span>).attr(<span class="hljs-string">"transform"</span>, <span class="hljs-string">"rotate(270)"</span>)
.attr(<span class="hljs-string">"x"</span>, -width / <span class="hljs-number">2</span>).attr(<span class="hljs-string">"y"</span>, <span class="hljs-number">-25</span>).text(<span class="hljs-string">"Actual PISA"</span>);

<span class="hljs-keyword">var</span> identityLine = svg.append(<span class="hljs-string">"line"</span>)
.attr(<span class="hljs-string">"class"</span>, <span class="hljs-string">"estimated"</span>)
.attr(<span class="hljs-string">"x1"</span>, xScale(extent[<span class="hljs-number">0</span>]))
.attr(<span class="hljs-string">"y1"</span>, yScale(extent[<span class="hljs-number">0</span>]))
.attr(<span class="hljs-string">"x2"</span>, xScale(extent[<span class="hljs-number">1</span>]))
.attr(<span class="hljs-string">"y2"</span>, yScale(extent[<span class="hljs-number">1</span>]))
.style(<span class="hljs-string">"stroke"</span>, <span class="hljs-string">"#e41a1c"</span>);

<span class="hljs-keyword">var</span> label = svg.append(<span class="hljs-string">"text"</span>);

<span class="hljs-keyword">var</span> normalGenerator = d3.randomNormal();

<span class="hljs-keyword">var</span> points = [];

<span class="hljs-keyword">var</span> predictedVariable = <span class="hljs-string">"PISA"</span>;
<span class="hljs-keyword">var</span> inputVariables = [<span class="hljs-string">"Income"</span>, <span class="hljs-string">"Inequality"</span>, <span class="hljs-string">"EduSpend"</span>, <span class="hljs-string">"HDI"</span>];
<span class="hljs-keyword">var</span> variableMean = {};
<span class="hljs-keyword">var</span> variableStdDev = {};

<span class="hljs-keyword">var</span> randomModel = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">var</span> model = { <span class="hljs-attr">intercept</span>: <span class="hljs-number">0.0</span> };
	
	inputVariables.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">variable</span>) </span>{
		model[variable] = normalGenerator() * <span class="hljs-number">0.01</span>;
	});
	
	<span class="hljs-keyword">return</span> model;
}

<span class="hljs-keyword">var</span> model = randomModel();

<span class="hljs-comment">// Get the "residual", or difference between observed value and predicted value</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateErrors</span>(<span class="hljs-params">points, model</span>) </span>{
	points.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">point</span>) </span>{
		<span class="hljs-comment">// Y = ... + b</span>
		point[<span class="hljs-string">"prediction"</span>] = model.intercept;
		inputVariables.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">variable</span>) </span>{
			<span class="hljs-comment">// Y = mx...</span>
			point[<span class="hljs-string">"prediction"</span>] += model[variable] * point[variable];
		});
		<span class="hljs-comment">// Real Y - our current guess</span>
		point.error = point[predictedVariable] - point[<span class="hljs-string">"prediction"</span>];
	});
}

<span class="hljs-comment">// Display the squared loss criterion</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">squaredError</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">return</span> d3.sum(points, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">point</span>) </span>{
		<span class="hljs-keyword">return</span> point.error * point.error;
	});
}

<span class="hljs-keyword">var</span> lossFunction = squaredError;
<span class="hljs-keyword">var</span> rounder = d3.format(<span class="hljs-string">".5g"</span>);

<span class="hljs-keyword">var</span> modelText = svg.append(<span class="hljs-string">"text"</span>)
.attr(<span class="hljs-string">"id"</span>, <span class="hljs-string">"status"</span>)
.attr(<span class="hljs-string">"x"</span>, <span class="hljs-number">10</span>).attr(<span class="hljs-string">"y"</span>, <span class="hljs-number">30</span>)
.text(<span class="hljs-string">"Loss: "</span> +
rounder(lossFunction()));

<span class="hljs-comment">// Save data values outside the callback function. (Useful for debugging.)</span>
<span class="hljs-keyword">var</span> pisa, gdp, education, gini, hdi;

d3.queue()
.defer(d3.tsv, <span class="hljs-string">"pisa.txt"</span>)
.defer(d3.tsv, <span class="hljs-string">"gdp.txt"</span>)
.defer(d3.tsv, <span class="hljs-string">"education.txt"</span>)
.defer(d3.tsv, <span class="hljs-string">"gini.txt"</span>)
.defer(d3.tsv, <span class="hljs-string">"hdi.txt"</span>)
.await(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, _pisa, _gdp, _education, _gini, _hdi</span>) </span>{
	points = [];
	gdp = d3.nest().key(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{ <span class="hljs-keyword">return</span> d.Country; }).map(_gdp);
	education = d3.nest().key(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{ <span class="hljs-keyword">return</span> d.Country; }).map(_education);
	gini = d3.nest().key(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{ <span class="hljs-keyword">return</span> d.Country; }).map(_gini);
	hdi = d3.nest().key(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{ <span class="hljs-keyword">return</span> d.Country; }).map(_hdi);
	
	_pisa.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">country</span>) </span>{
		<span class="hljs-keyword">var</span> countryName = country.Country;
		<span class="hljs-keyword">try</span> {
			country[<span class="hljs-string">"PISA"</span>] = country[<span class="hljs-string">"PISA"</span>];
			country[<span class="hljs-string">"Income"</span>] = gdp.get(countryName)[<span class="hljs-number">0</span>][<span class="hljs-string">"GDP"</span>]);
			country[<span class="hljs-string">"EduSpend"</span>] = education.get(countryName)[<span class="hljs-number">0</span>][<span class="hljs-string">"Education"</span>];
			country[<span class="hljs-string">"Inequality"</span>] = gini.get(countryName)[<span class="hljs-number">0</span>][<span class="hljs-string">"WBGini"</span>];
			country[<span class="hljs-string">"HDI"</span>] = hdi.get(countryName)[<span class="hljs-number">0</span>][<span class="hljs-string">"HDI"</span>];
			
			points.push(country);
		} <span class="hljs-keyword">catch</span> (error) { 
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"problem with "</span> + countryName);
		}
	});
	
	model.intercept = d3.mean(points, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{ <span class="hljs-keyword">return</span> d[predictedVariable]; });
	
	<span class="hljs-keyword">var</span> slidersDiv = d3.select(<span class="hljs-string">"#plot"</span>).append(<span class="hljs-string">"div"</span>)
	.style(<span class="hljs-string">"float"</span>, <span class="hljs-string">"right"</span>);
	
	slidersDiv
	.append(<span class="hljs-string">"div"</span>).text(<span class="hljs-string">"Intercept"</span>)
	.append(<span class="hljs-string">"div"</span>)
	.append(<span class="hljs-string">"input"</span>).attr(<span class="hljs-string">"type"</span>, <span class="hljs-string">"range"</span>).attr(<span class="hljs-string">"class"</span>, <span class="hljs-string">"slider"</span>)
	.attr(<span class="hljs-string">"min"</span>, model.intercept - <span class="hljs-number">200</span>)
	.attr(<span class="hljs-string">"max"</span>, model.intercept + <span class="hljs-number">200</span>).attr(<span class="hljs-string">"step"</span>, <span class="hljs-number">2</span>)
	.attr(<span class="hljs-string">"value"</span>, model.intercept)
	.on(<span class="hljs-string">"input"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
		model.intercept = <span class="hljs-built_in">Number</span>(<span class="hljs-keyword">this</span>.value);
		display();
	});
	
	inputVariables.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">variable</span>) </span>{
		variableMean[variable] = d3.mean(points, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{ <span class="hljs-keyword">return</span> d[variable]; });
		variableStdDev[variable] = d3.deviation(points, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{ <span class="hljs-keyword">return</span> d[variable]; });
		
		<span class="hljs-keyword">var</span> varMin = <span class="hljs-number">-30</span> / variableStdDev[variable];
		<span class="hljs-keyword">var</span> varMax = <span class="hljs-number">30</span> / variableStdDev[variable];
		<span class="hljs-keyword">var</span> step = (varMax - varMin) / <span class="hljs-number">100</span>;
		slidersDiv
		.append(<span class="hljs-string">"div"</span>).text(variable)
		.append(<span class="hljs-string">"div"</span>)
		.append(<span class="hljs-string">"input"</span>).attr(<span class="hljs-string">"type"</span>, <span class="hljs-string">"range"</span>).attr(<span class="hljs-string">"class"</span>, <span class="hljs-string">"slider"</span>)
		.attr(<span class="hljs-string">"min"</span>, varMin).attr(<span class="hljs-string">"max"</span>, varMax).attr(<span class="hljs-string">"step"</span>, step).attr(<span class="hljs-string">"value"</span>, model[variable])
		.on(<span class="hljs-string">"input"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
			model[variable] = <span class="hljs-built_in">Number</span>(<span class="hljs-keyword">this</span>.value);
			display();
		});
	});
	
	display();
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">display</span>(<span class="hljs-params"></span>) </span>{
	calculateErrors(points, model);

	<span class="hljs-keyword">var</span> circles = svg.selectAll(<span class="hljs-string">"circle"</span>).data(points);
	
	circles.enter()
	.append(<span class="hljs-string">"circle"</span>)
	.merge(circles)
	.attr(<span class="hljs-string">"r"</span>, <span class="hljs-number">5</span>)
	.on(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{
		label.attr(<span class="hljs-string">"x"</span>, xScale(d[<span class="hljs-string">"prediction"</span>]))
		.attr(<span class="hljs-string">"y"</span>, yScale(d[predictedVariable]))
		.text(d.Country);
	})
	.style(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">0.4</span>)
	.attr(<span class="hljs-string">"cx"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{ <span class="hljs-keyword">return</span> xScale(d[<span class="hljs-string">"prediction"</span>]); })
	.attr(<span class="hljs-string">"cy"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{ <span class="hljs-keyword">return</span> yScale(d[predictedVariable]); });

	modelText
	.text(<span class="hljs-string">"Loss: "</span> + rounder(lossFunction()));	
}

</span></code></pre>


<script>
document.getElementById("display").innerText = document.getElementById("notes").innerText;
hljs.initHighlightingOnLoad();
</script>




</body></html>